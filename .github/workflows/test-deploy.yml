name: Test Deploy

on:
  workflow_dispatch:
    inputs:
      use_vm:
        description: 'Create TD VM for quote generation'
        required: false
        default: 'true'
        type: boolean

permissions:
  contents: write

jobs:
  deploy:
    runs-on: [self-hosted, tdx]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check TDX environment
        run: |
          echo "=== System Info ==="
          uname -a
          echo ""
          echo "=== TDX Detection ==="
          python3 -c "
          import sys
          sys.path.insert(0, 'action/src')
          from vm import get_tdx_info, find_existing_images
          import json

          print('TDX Info:')
          info = get_tdx_info()
          print(json.dumps(info, indent=2))

          print('\nExisting Images:')
          images = find_existing_images()
          for img in images:
              print(f'  {img[\"path\"]} ({img[\"size_gb\"]} GB)')
          if not images:
              print('  No images found')
          "
          echo ""
          echo "=== Libvirt Status ==="
          virsh version 2>/dev/null || echo "virsh not available"
          virsh list --all 2>/dev/null || echo "Cannot list VMs"
          echo ""
          echo "=== TDX Kernel Module ==="
          cat /sys/module/kvm_intel/parameters/tdx 2>/dev/null || echo "TDX param not found"
          dmesg | grep -i tdx | head -5 || echo "No TDX in dmesg"

      - name: Deploy example service (direct on host)
        if: ${{ inputs.use_vm != 'true' }}
        run: |
          cd example
          docker compose up -d
          sleep 3
          docker compose ps

      - name: Create TD VM with workload
        if: ${{ inputs.use_vm == 'true' }}
        id: vm
        run: |
          echo "Creating TD VM..."
          python3 action/src/vm.py example/docker-compose.yml > vm_result.json 2>&1 || {
            echo "VM creation failed, falling back to direct deployment"
            cat vm_result.json || true
            cd example && docker compose up -d
            echo '{"success": false, "quote": "placeholder-no-vm"}' > vm_result.json
          }
          cat vm_result.json

          # Extract outputs
          QUOTE=$(python3 -c "import json; d=json.load(open('vm_result.json')); print(d.get('quote', ''))")
          IP=$(python3 -c "import json; d=json.load(open('vm_result.json')); print(d.get('ip', 'localhost'))")
          echo "quote=$QUOTE" >> $GITHUB_OUTPUT
          echo "vm_ip=$IP" >> $GITHUB_OUTPUT

      - name: Generate TDX quote (fallback)
        if: ${{ inputs.use_vm != 'true' }}
        id: quote
        run: |
          python3 action/src/quote.py

      - name: Test service
        run: |
          IP="${{ steps.vm.outputs.vm_ip || 'localhost' }}"
          echo "Testing service at $IP:8080..."
          curl -s --connect-timeout 5 http://$IP:8080 || echo "Service not reachable"

      - name: Create release with attestation
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ENDPOINT: "http://${{ steps.vm.outputs.vm_ip || '57.130.10.77' }}:8080"
          QUOTE: ${{ steps.vm.outputs.quote || steps.quote.outputs.quote || 'placeholder' }}
          MEASUREMENTS: ${{ steps.quote.outputs.measurements || '{}' }}
        run: |
          python3 action/src/release.py
