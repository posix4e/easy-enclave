name: Test Deploy

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy:
    runs-on: [self-hosted, tdx]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy with Easy Enclave Action
        id: deploy
        uses: ./action
        with:
          docker-compose: ./example/docker-compose.yml
          endpoint: auto
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Test deployed service
        run: |
          echo "Testing service at ${{ steps.deploy.outputs.vm_ip }}:8080..."
          curl -s --connect-timeout 30 --retry 5 --retry-delay 10 http://${{ steps.deploy.outputs.vm_ip }}:8080

      - name: Verify with SDK
        run: |
          python3 -m pip install -e sdk
          python3 example/verify.py ${{ github.repository }}
