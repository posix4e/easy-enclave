name: Test Deploy

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy:
    runs-on: [self-hosted, tdx]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check TDX environment
        run: |
          echo "=== System Info ==="
          uname -a
          echo ""
          echo "=== TDX Detection ==="
          python3 -c "
          import sys
          sys.path.insert(0, 'action/src')
          from workload import get_tdx_info
          import json
          print('TDX Info:')
          info = get_tdx_info()
          print(json.dumps(info, indent=2))
          "
          echo ""
          echo "=== TDX Devices ==="
          ls -la /dev/tdx* 2>/dev/null || echo "No /dev/tdx devices"
          ls -la /sys/kernel/config/tsm/report 2>/dev/null || echo "No configfs-tsm"
          ls -la /var/run/tdx-qgs/ 2>/dev/null || echo "No QGS socket dir"
          echo ""
          echo "=== Docker ==="
          docker --version
          docker-compose --version || docker compose version

      - name: Run workload
        id: workload
        run: |
          echo "Starting workload..."
          python3 action/src/workload.py example/docker-compose.yml | tee workload_result.json

          # Extract outputs
          QUOTE=$(python3 -c "import json; d=json.load(open('workload_result.json')); print(d['quote'])")
          ENDPOINT=$(python3 -c "import json; d=json.load(open('workload_result.json')); print(d['endpoint'])")
          echo "quote=$QUOTE" >> $GITHUB_OUTPUT
          echo "endpoint=$ENDPOINT" >> $GITHUB_OUTPUT
          echo "Endpoint: $ENDPOINT"
          echo "Quote length: ${#QUOTE}"

      - name: Test service
        run: |
          ENDPOINT="${{ steps.workload.outputs.endpoint }}"
          echo "Testing service at $ENDPOINT..."
          curl -s --connect-timeout 10 --retry 3 "$ENDPOINT"

      - name: Create release with attestation
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ENDPOINT: ${{ steps.workload.outputs.endpoint }}
          QUOTE: ${{ steps.workload.outputs.quote }}
        run: |
          python3 action/src/release.py

      - name: Cleanup
        if: always()
        run: |
          docker-compose -f example/docker-compose.yml down --remove-orphans || true
