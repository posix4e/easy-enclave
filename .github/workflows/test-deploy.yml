name: Test Deploy

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy:
    runs-on: [self-hosted, tdx]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup libvirt network
        run: |
          echo "=== Checking libvirt networks ==="
          virsh net-list --all

          # Ensure virbr0 exists for default network
          if ! ip link show virbr0 &>/dev/null; then
            echo "Creating virbr0 bridge..."
            sudo ip link add virbr0 type bridge
            sudo ip addr add 192.168.122.1/24 dev virbr0
            sudo ip link set virbr0 up
          fi

          # Start default network if not running
          if ! virsh net-info default 2>/dev/null | grep -q "Active:.*yes"; then
            echo "Starting default network..."
            virsh net-undefine default 2>/dev/null || true
            virsh net-define /usr/share/libvirt/networks/default.xml
            virsh net-start default
            virsh net-autostart default
          fi

          echo "=== Network status ==="
          virsh net-list --all
          ip addr show virbr0

      - name: Check TDX environment
        run: |
          echo "=== System Info ==="
          uname -a
          echo ""
          echo "=== TDX Detection ==="
          python3 -c "
          import sys
          sys.path.insert(0, 'action/src')
          from vm import get_tdx_info, find_existing_images
          import json

          print('TDX Info:')
          info = get_tdx_info()
          print(json.dumps(info, indent=2))

          print('\nExisting Images:')
          images = find_existing_images()
          for img in images:
              print(f'  {img[\"path\"]} ({img[\"size_gb\"]} GB)')
          if not images:
              print('  No images found')
          "
          echo ""
          echo "=== Libvirt Status ==="
          virsh version 2>/dev/null || echo "virsh not available"
          virsh list --all 2>/dev/null || echo "Cannot list VMs"
          echo ""
          echo "=== TDX Kernel Module ==="
          cat /sys/module/kvm_intel/parameters/tdx 2>/dev/null || echo "TDX param not found"

      - name: Create TD VM with workload
        id: vm
        run: |
          echo "Creating TD VM..."
          python3 action/src/vm.py example/docker-compose.yml | tee vm_result.json

          # Extract outputs - fail if missing
          QUOTE=$(python3 -c "import json; d=json.load(open('vm_result.json')); print(d['quote'])")
          IP=$(python3 -c "import json; d=json.load(open('vm_result.json')); print(d['ip'])")
          echo "quote=$QUOTE" >> $GITHUB_OUTPUT
          echo "vm_ip=$IP" >> $GITHUB_OUTPUT
          echo "VM IP: $IP"
          echo "Quote: $QUOTE"

      - name: Test service
        run: |
          IP="${{ steps.vm.outputs.vm_ip }}"
          echo "Testing service at $IP:8080..."
          curl -s --connect-timeout 30 --retry 3 http://$IP:8080

      - name: Create release with attestation
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ENDPOINT: "http://${{ steps.vm.outputs.vm_ip }}:8080"
          QUOTE: ${{ steps.vm.outputs.quote }}
        run: |
          python3 action/src/release.py
