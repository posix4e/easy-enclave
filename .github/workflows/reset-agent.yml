name: Reset Agent VM

on:
  workflow_dispatch:
    inputs:
      control_vm_name:
        description: "Control-plane agent VM name"
        required: false
        default: "ee-control"
      control_vm_port:
        description: "Control-plane agent port (inside VM)"
        required: false
        default: "8000"
      control_host_port:
        description: "Host port to forward to the control agent"
        required: false
        default: "443"
      contact_vm_name:
        description: "Contacts agent VM name"
        required: false
        default: "ee-contacts"
      contact_vm_port:
        description: "Contacts agent port (inside VM)"
        required: false
        default: "8001"
      contact_host_port:
        description: "Host port to forward to the contacts agent"
        required: false
        default: "443"
      control_public_ip:
        description: "Public IP to map to control agent (optional)"
        required: false
        default: "57.130.10.246"
      contact_public_ip:
        description: "Public IP to map to contacts agent (optional)"
        required: false
        default: "57.130.34.193"
      vm_image_tag:
        description: "Tag for the new pristine agent images"
        required: false
        default: "reset-${{ github.run_id }}"
      cleanup_vms:
        description: "Space-separated VM names to destroy/undefine (will add control/contact automatically)"
        required: false
        default: "ee-control ee-contacts ee-workload"

permissions:
  contents: read

jobs:
  reset-agent:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Reset agents (uninstall + install control/contacts)
        uses: ./.github/actions/reset-agents
        with:
          ssh-host: ${{ secrets.AGENT_SSH_HOST }}
          ssh-port: ${{ secrets.AGENT_SSH_PORT }}
          ssh-user: ${{ secrets.AGENT_SSH_USER }}
          ssh-key: ${{ secrets.AGENT_SSH_KEY }}
          control-vm-name: ${{ github.event.inputs.control_vm_name || 'ee-control' }}
          control-vm-port: ${{ github.event.inputs.control_vm_port || '8000' }}
          control-host-port: ${{ github.event.inputs.control_host_port || '443' }}
          control-public-ip: ${{ github.event.inputs.control_public_ip || '57.130.10.246' }}
          contact-vm-name: ${{ github.event.inputs.contact_vm_name || 'ee-contacts' }}
          contact-vm-port: ${{ github.event.inputs.contact_vm_port || '8001' }}
          contact-host-port: ${{ github.event.inputs.contact_host_port || '443' }}
          contact-public-ip: ${{ github.event.inputs.contact_public_ip || '57.130.34.193' }}
          vm-image-tag: ${{ github.event.inputs.vm_image_tag || format('reset-{0}', github.run_id) }}
          cleanup-vms: ${{ github.event.inputs.cleanup_vms || 'ee-control ee-contacts ee-workload' }}
