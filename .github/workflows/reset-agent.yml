name: Installer Agents

on:
  workflow_dispatch:
    inputs:
      control_vm_name:
        description: "Control-plane agent VM name"
        required: false
        default: "ee-control"
      control_vm_port:
        description: "Control-plane agent port (inside VM)"
        required: false
        default: "8000"
      control_host_port:
        description: "Host port to forward to the control agent"
        required: false
        default: "443"
      control_public_ip:
        description: "Public IP to map to control agent (optional)"
        required: false
        default: "57.130.10.246"
      control_ssh_host:
        description: "SSH host for the control-plane VM host (fallback: AGENT_SSH_HOST)"
        required: false
        default: ""
      control_ssh_port:
        description: "SSH port for the control-plane VM host (fallback: AGENT_SSH_PORT)"
        required: false
        default: ""
      control_ssh_user:
        description: "SSH user for the control-plane VM host (fallback: AGENT_SSH_USER)"
        required: false
        default: ""
      control_ssh_key:
        description: "SSH private key for the control-plane VM host (fallback: AGENT_SSH_KEY)"
        required: false
        default: ""
      contact_vm_name:
        description: "Contacts agent VM name"
        required: false
        default: "ee-contacts"
      contact_vm_port:
        description: "Contacts agent port (inside VM)"
        required: false
        default: "8000"
      contact_host_port:
        description: "Host port to forward to the contacts agent"
        required: false
        default: "443"
      contact_public_ip:
        description: "Public IP to map to contacts agent (optional)"
        required: false
        default: "57.130.34.193"
      contact_ssh_host:
        description: "SSH host for the contacts VM host (fallback: CONTACT_SSH_HOST or AGENT_SSH_HOST)"
        required: false
        default: ""
      contact_ssh_port:
        description: "SSH port for the contacts VM host (fallback: CONTACT_SSH_PORT or AGENT_SSH_PORT)"
        required: false
        default: ""
      contact_ssh_user:
        description: "SSH user for the contacts VM host (fallback: CONTACT_SSH_USER or AGENT_SSH_USER)"
        required: false
        default: ""
      contact_ssh_key:
        description: "SSH private key for the contacts VM host (fallback: CONTACT_SSH_KEY or AGENT_SSH_KEY)"
        required: false
        default: ""
      vm_image_tag:
        description: "Tag for the new pristine agent images"
        required: false
        default: ""

permissions:
  contents: read

jobs:
  install-agents:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Uninstall contacts agent
        uses: ./action/uninstall-agent
        with:
          ssh-host: ${{ inputs.contact_ssh_host || secrets.CONTACT_SSH_HOST || secrets.AGENT_SSH_HOST }}
          ssh-port: ${{ inputs.contact_ssh_port || secrets.CONTACT_SSH_PORT || secrets.AGENT_SSH_PORT || '22' }}
          ssh-user: ${{ inputs.contact_ssh_user || secrets.CONTACT_SSH_USER || secrets.AGENT_SSH_USER || 'ubuntu' }}
          ssh-key: ${{ inputs.contact_ssh_key || secrets.CONTACT_SSH_KEY || secrets.AGENT_SSH_KEY }}
          vm-name: ${{ inputs.contact_vm_name || 'ee-contacts' }}
          vm-port: ${{ inputs.contact_vm_port || '8001' }}
          host-port: ${{ inputs.contact_host_port || '443' }}
          public-ip: ${{ inputs.contact_public_ip || '57.130.34.193' }}

      - name: Uninstall control-plane agent
        uses: ./action/uninstall-agent
        with:
          ssh-host: ${{ inputs.control_ssh_host || secrets.AGENT_SSH_HOST }}
          ssh-port: ${{ inputs.control_ssh_port || secrets.AGENT_SSH_PORT || '22' }}
          ssh-user: ${{ inputs.control_ssh_user || secrets.AGENT_SSH_USER || 'ubuntu' }}
          ssh-key: ${{ inputs.control_ssh_key || secrets.AGENT_SSH_KEY }}
          vm-name: ${{ inputs.control_vm_name || 'ee-control' }}
          vm-port: ${{ inputs.control_vm_port || '8000' }}
          host-port: ${{ inputs.control_host_port || '443' }}
          public-ip: ${{ inputs.control_public_ip || '57.130.10.246' }}

      - name: Install control-plane agent
        uses: ./action/install-control-agent
        with:
          ssh-host: ${{ inputs.control_ssh_host || secrets.AGENT_SSH_HOST }}
          ssh-port: ${{ inputs.control_ssh_port || secrets.AGENT_SSH_PORT || '22' }}
          ssh-user: ${{ inputs.control_ssh_user || secrets.AGENT_SSH_USER || 'ubuntu' }}
          ssh-key: ${{ inputs.control_ssh_key || secrets.AGENT_SSH_KEY }}
          vm-name: ${{ inputs.control_vm_name || 'ee-control' }}
          vm-port: ${{ inputs.control_vm_port || '8000' }}
          host-port: ${{ inputs.control_host_port || '443' }}
          public-ip: ${{ inputs.control_public_ip || '57.130.10.246' }}
          dns-name: ${{ 'control.easyenclave.com' }}
          cloudflare-api-token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          cloudflare-zone: ${{ secrets.CLOUDFLARE_ZONE || 'easyenclave.com' }}
          cloudflare-zone-id: ${{ secrets.CLOUDFLARE_ZONE_ID }}
          vm-image-tag: ${{ inputs.vm_image_tag || '' }}

      - name: Install contacts agent
        uses: ./action/install-contacts-agent
        with:
          ssh-host: ${{ inputs.contact_ssh_host || secrets.CONTACT_SSH_HOST || secrets.AGENT_SSH_HOST }}
          ssh-port: ${{ inputs.contact_ssh_port || secrets.CONTACT_SSH_PORT || secrets.AGENT_SSH_PORT || '22' }}
          ssh-user: ${{ inputs.contact_ssh_user || secrets.CONTACT_SSH_USER || secrets.AGENT_SSH_USER || 'ubuntu' }}
          ssh-key: ${{ inputs.contact_ssh_key || secrets.CONTACT_SSH_KEY || secrets.AGENT_SSH_KEY }}
          vm-name: ${{ inputs.contact_vm_name || 'ee-contacts' }}
          vm-port: ${{ inputs.contact_vm_port || '8001' }}
          host-port: ${{ inputs.contact_host_port || '443' }}
          public-ip: ${{ inputs.contact_public_ip || '57.130.34.193' }}
          dns-name: ${{ 'contacts.easyenclave.com' }}
          cloudflare-api-token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          cloudflare-zone: ${{ secrets.CLOUDFLARE_ZONE || 'easyenclave.com' }}
          cloudflare-zone-id: ${{ secrets.CLOUDFLARE_ZONE_ID }}
          vm-image-tag: ${{ inputs.vm_image_tag || '' }}
