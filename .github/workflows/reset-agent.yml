name: Reset Agent VM

on:
  workflow_dispatch:
    inputs:
      control_vm_name:
        description: "Control-plane agent VM name"
        required: false
        default: "ee-control"
      control_vm_port:
        description: "Control-plane agent port (inside VM)"
        required: false
        default: "8000"
      control_host_port:
        description: "Host port to forward to the control agent"
        required: false
        default: "443"
      contact_vm_name:
        description: "Contacts agent VM name"
        required: false
        default: "ee-contacts"
      contact_vm_port:
        description: "Contacts agent port (inside VM)"
        required: false
        default: "8001"
      contact_host_port:
        description: "Host port to forward to the contacts agent"
        required: false
        default: "443"
      control_public_ip:
        description: "Public IP to map to control agent (optional)"
        required: false
        default: "57.130.10.246"
      contact_public_ip:
        description: "Public IP to map to contacts agent (optional)"
        required: false
        default: "57.130.34.193"
      vm_image_tag:
        description: "Tag for the new pristine agent images"
        required: false
        default: "reset-${{ github.run_id }}"
      cleanup_vms:
        description: "Space-separated VM names to destroy/undefine (will add control/contact automatically)"
        required: false
        default: "ee-control ee-contacts ee-workload"

permissions:
  contents: read

jobs:
  reset-agent:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare SSH key
        id: ssh-key
        run: |
          set -euo pipefail
          KEY_FILE=$(mktemp)
          chmod 600 "$KEY_FILE"
          printf '%s\n' "${{ secrets.AGENT_SSH_KEY }}" > "$KEY_FILE"
          echo "file=$KEY_FILE" >> "$GITHUB_OUTPUT"

      - name: Cleanup old agent VMs and port forwards
        env:
          SSH_KEY: ${{ steps.ssh-key.outputs.file }}
          CONTROL_VM_NAME: ${{ github.event.inputs.control_vm_name || 'ee-control' }}
          CONTROL_VM_PORT: ${{ github.event.inputs.control_vm_port || '8000' }}
          CONTROL_HOST_PORT: ${{ github.event.inputs.control_host_port || '8000' }}
          CONTACT_VM_NAME: ${{ github.event.inputs.contact_vm_name || 'ee-contacts' }}
          CONTACT_VM_PORT: ${{ github.event.inputs.contact_vm_port || '8001' }}
          CONTACT_HOST_PORT: ${{ github.event.inputs.contact_host_port || '8001' }}
          CONTROL_PUBLIC_IP: ${{ github.event.inputs.control_public_ip || '57.130.10.246' }}
          CONTACT_PUBLIC_IP: ${{ github.event.inputs.contact_public_ip || '57.130.34.193' }}
          CLEANUP_VMS: ${{ github.event.inputs.cleanup_vms || 'ee-control ee-contacts ee-workload' }}
        run: |
          set -euo pipefail
          ssh -o StrictHostKeyChecking=no -p "${{ secrets.AGENT_SSH_PORT }}" -i "$SSH_KEY" \
            "${{ secrets.AGENT_SSH_USER }}@${{ secrets.AGENT_SSH_HOST }}" <<EOF
set -euo pipefail
ALL_VMS="${CLEANUP_VMS} ${CONTROL_VM_NAME} ${CONTACT_VM_NAME}"
echo "Cleaning up VMs: ${ALL_VMS}"
for vm in ${ALL_VMS}; do
  sudo virsh destroy "$vm" >/dev/null 2>&1 || true
  sudo virsh undefine "$vm" --nvram --managed-save --remove-all-storage >/dev/null 2>&1 || \
    sudo virsh undefine "$vm" --nvram --remove-all-storage >/dev/null 2>&1 || true
done

python3 - <<'PY'
import subprocess

ports = [
    (int("${CONTROL_HOST_PORT}"), int("${CONTROL_VM_PORT}"), "${CONTROL_PUBLIC_IP}"),
    (int("${CONTACT_HOST_PORT}"), int("${CONTACT_VM_PORT}"), "${CONTACT_PUBLIC_IP}"),
]

def delete_nat(chain: str, host_port: int, ip: str) -> None:
    result = subprocess.run(
        ["sudo", "iptables", "-t", "nat", "-L", chain, "--line-numbers"],
        capture_output=True,
        text=True,
    )
    if result.returncode != 0:
        return
    nums = []
    for line in result.stdout.splitlines():
        parts = line.split()
        if not parts or not parts[0].isdigit():
            continue
        if f"dpt:{host_port}" in line and "DNAT" in line and (not ip or ip in line):
            nums.append(int(parts[0]))
    for num in reversed(nums):
        subprocess.run(["sudo", "iptables", "-t", "nat", "-D", chain, str(num)])

def delete_forward(chain: str, vm_port: int) -> None:
    result = subprocess.run(
        ["sudo", "iptables", "-L", chain, "--line-numbers"],
        capture_output=True,
        text=True,
    )
    if result.returncode != 0:
        return
    nums = []
    for line in result.stdout.splitlines():
        parts = line.split()
        if not parts or not parts[0].isdigit():
            continue
        if f"dpt:{vm_port}" in line and "ACCEPT" in line:
            nums.append(int(parts[0]))
    for num in reversed(nums):
        subprocess.run(["sudo", "iptables", "-D", chain, str(num)])

for host_port, vm_port, ip in ports:
    delete_nat("PREROUTING", host_port, ip)
    delete_nat("OUTPUT", host_port, ip)
    delete_forward("FORWARD", vm_port)
    delete_forward("LIBVIRT_FWI", vm_port)
PY

echo "Cleanup complete."
EOF

      - name: Install fresh agent VM
        env:
          SSH_KEY: ${{ steps.ssh-key.outputs.file }}
          CONTROL_VM_NAME: ${{ github.event.inputs.control_vm_name || 'ee-control' }}
          CONTROL_VM_PORT: ${{ github.event.inputs.control_vm_port || '8000' }}
          CONTROL_HOST_PORT: ${{ github.event.inputs.control_host_port || '8000' }}
          CONTACT_VM_NAME: ${{ github.event.inputs.contact_vm_name || 'ee-contacts' }}
          CONTACT_VM_PORT: ${{ github.event.inputs.contact_vm_port || '8001' }}
          CONTACT_HOST_PORT: ${{ github.event.inputs.contact_host_port || '8001' }}
          CONTROL_PUBLIC_IP: ${{ github.event.inputs.control_public_ip || '57.130.10.246' }}
          CONTACT_PUBLIC_IP: ${{ github.event.inputs.contact_public_ip || '57.130.34.193' }}
          VM_IMAGE_TAG: ${{ github.event.inputs.vm_image_tag || format('reset-{0}', github.run_id) }}
        run: |
          set -euo pipefail
          ssh -o StrictHostKeyChecking=no -p "${{ secrets.AGENT_SSH_PORT }}" -i "$SSH_KEY" \
            "${{ secrets.AGENT_SSH_USER }}@${{ secrets.AGENT_SSH_HOST }}" <<EOF
set -euo pipefail
sudo rm -rf /opt/easy-enclave
sudo git clone https://github.com/${{ github.repository }}.git /opt/easy-enclave
cd /opt/easy-enclave
sudo git fetch --tags origin
sudo git checkout "${GITHUB_SHA}"
echo "Installing control agent ${CONTROL_VM_NAME}:${CONTROL_VM_PORT} -> host ${CONTROL_HOST_PORT}"
sudo ./install-agent.sh --non-interactive \
  --vm-name "${CONTROL_VM_NAME}" \
  --vm-port "${CONTROL_VM_PORT}" \
  --host-port "${CONTROL_HOST_PORT}" \
  --vm-image-tag "${VM_IMAGE_TAG}"
echo "Installing contacts agent ${CONTACT_VM_NAME}:${CONTACT_VM_PORT} -> host ${CONTACT_HOST_PORT}"
sudo ./install-agent.sh --non-interactive \
  --vm-name "${CONTACT_VM_NAME}" \
  --vm-port "${CONTACT_VM_PORT}" \
  --host-port "${CONTACT_HOST_PORT}" \
  --vm-image-tag "${VM_IMAGE_TAG}"

get_ip() {
  local name="$1"
  ip=$(sudo virsh domifaddr "$name" --source lease | awk '/ipv4/ {print $4}' | head -n1 | cut -d/ -f1)
  echo "$ip"
}

CONTROL_VM_IP=$(get_ip "${CONTROL_VM_NAME}")
CONTACT_VM_IP=$(get_ip "${CONTACT_VM_NAME}")

echo "Control VM IP: ${CONTROL_VM_IP}"
echo "Contacts VM IP: ${CONTACT_VM_IP}"

configure_forward() {
  local pub_ip="$1"
  local host_port="$2"
  local vm_ip="$3"
  local vm_port="$4"
  if [ -z "$pub_ip" ] || [ -z "$vm_ip" ]; then
    echo "Skipping forward for pub_ip=$pub_ip vm_ip=$vm_ip"
    return
  fi
  sudo iptables -t nat -A PREROUTING -d "$pub_ip" -p tcp --dport "$host_port" -j DNAT --to-destination "${vm_ip}:${vm_port}"
  sudo iptables -t nat -A OUTPUT -d "$pub_ip" -p tcp --dport "$host_port" -j DNAT --to-destination "${vm_ip}:${vm_port}"
  sudo iptables -I LIBVIRT_FWI -p tcp -d "$vm_ip" --dport "$vm_port" -j ACCEPT
  sudo iptables -A FORWARD -p tcp -d "$vm_ip" --dport "$vm_port" -j ACCEPT
  echo "Forwarded ${pub_ip}:${host_port} -> ${vm_ip}:${vm_port}"
}

configure_forward "${CONTROL_PUBLIC_IP}" "${CONTROL_HOST_PORT}" "${CONTROL_VM_IP}" "${CONTROL_VM_PORT}"
configure_forward "${CONTACT_PUBLIC_IP}" "${CONTACT_HOST_PORT}" "${CONTACT_VM_IP}" "${CONTACT_VM_PORT}"
EOF

      - name: Verify agent is reachable
        env:
          SSH_KEY: ${{ steps.ssh-key.outputs.file }}
          CONTROL_HOST_PORT: ${{ github.event.inputs.control_host_port || '8000' }}
          CONTACT_HOST_PORT: ${{ github.event.inputs.contact_host_port || '8001' }}
        run: |
          set -euo pipefail
          ssh -o StrictHostKeyChecking=no -p "${{ secrets.AGENT_SSH_PORT }}" -i "$SSH_KEY" \
            "${{ secrets.AGENT_SSH_USER }}@${{ secrets.AGENT_SSH_HOST }}" \
            "for port in ${CONTROL_HOST_PORT} ${CONTACT_HOST_PORT}; do
               curl -fsSk --max-time 10 https://127.0.0.1:${port}/health || (sudo ss -lntp && exit 1)
             done"
