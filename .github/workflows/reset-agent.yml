name: Reset Agent VM

on:
  workflow_dispatch:
    inputs:
      control_vm_name:
        description: "Control-plane agent VM name"
        required: false
        default: "ee-control"
      control_vm_port:
        description: "Control-plane agent port (inside VM)"
        required: false
        default: "8000"
      control_host_port:
        description: "Host port to forward to the control agent"
        required: false
        default: "8000"
      contact_vm_name:
        description: "Contacts agent VM name"
        required: false
        default: "ee-contacts"
      contact_vm_port:
        description: "Contacts agent port (inside VM)"
        required: false
        default: "8001"
      contact_host_port:
        description: "Host port to forward to the contacts agent"
        required: false
        default: "8001"
      vm_image_tag:
        description: "Tag for the new pristine agent images"
        required: false
        default: "reset-${{ github.run_id }}"
      cleanup_vms:
        description: "Space-separated VM names to destroy/undefine (will add control/contact automatically)"
        required: false
        default: "ee-control ee-contacts ee-workload"

permissions:
  contents: read

jobs:
  reset-agent:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare SSH key
        id: ssh-key
        run: |
          set -euo pipefail
          KEY_FILE=$(mktemp)
          chmod 600 "$KEY_FILE"
          printf '%s\n' "${{ secrets.AGENT_SSH_KEY }}" > "$KEY_FILE"
          echo "file=$KEY_FILE" >> "$GITHUB_OUTPUT"

      - name: Cleanup old agent VMs and port forwards
        env:
          SSH_KEY: ${{ steps.ssh-key.outputs.file }}
          CONTROL_VM_NAME: ${{ github.event.inputs.control_vm_name || 'ee-control' }}
          CONTROL_VM_PORT: ${{ github.event.inputs.control_vm_port || '8000' }}
          CONTROL_HOST_PORT: ${{ github.event.inputs.control_host_port || '8000' }}
          CONTACT_VM_NAME: ${{ github.event.inputs.contact_vm_name || 'ee-contacts' }}
          CONTACT_VM_PORT: ${{ github.event.inputs.contact_vm_port || '8001' }}
          CONTACT_HOST_PORT: ${{ github.event.inputs.contact_host_port || '8001' }}
          CLEANUP_VMS: ${{ github.event.inputs.cleanup_vms || 'ee-control ee-contacts ee-workload' }}
        run: |
          set -euo pipefail
          ssh -o StrictHostKeyChecking=no -p "${{ secrets.AGENT_SSH_PORT }}" -i "$SSH_KEY" \
            "${{ secrets.AGENT_SSH_USER }}@${{ secrets.AGENT_SSH_HOST }}" <<EOF
set -euo pipefail
ALL_VMS="${CLEANUP_VMS} ${CONTROL_VM_NAME} ${CONTACT_VM_NAME}"
echo "Cleaning up VMs: ${ALL_VMS}"
for vm in ${ALL_VMS}; do
  sudo virsh destroy "$vm" >/dev/null 2>&1 || true
  sudo virsh undefine "$vm" --nvram --managed-save --remove-all-storage >/dev/null 2>&1 || \
    sudo virsh undefine "$vm" --nvram --remove-all-storage >/dev/null 2>&1 || true
done

python3 - <<'PY'
import subprocess

ports = [
    (int("${CONTROL_HOST_PORT}"), int("${CONTROL_VM_PORT}")),
    (int("${CONTACT_HOST_PORT}"), int("${CONTACT_VM_PORT}")),
]

def delete_nat(chain: str, host_port: int) -> None:
    result = subprocess.run(
        ["sudo", "iptables", "-t", "nat", "-L", chain, "--line-numbers"],
        capture_output=True,
        text=True,
    )
    if result.returncode != 0:
        return
    nums = []
    for line in result.stdout.splitlines():
        parts = line.split()
        if not parts or not parts[0].isdigit():
            continue
        if f"dpt:{host_port}" in line and "DNAT" in line:
            nums.append(int(parts[0]))
    for num in reversed(nums):
        subprocess.run(["sudo", "iptables", "-t", "nat", "-D", chain, str(num)])

def delete_forward(chain: str, vm_port: int) -> None:
    result = subprocess.run(
        ["sudo", "iptables", "-L", chain, "--line-numbers"],
        capture_output=True,
        text=True,
    )
    if result.returncode != 0:
        return
    nums = []
    for line in result.stdout.splitlines():
        parts = line.split()
        if not parts or not parts[0].isdigit():
            continue
        if f"dpt:{vm_port}" in line and "ACCEPT" in line:
            nums.append(int(parts[0]))
    for num in reversed(nums):
        subprocess.run(["sudo", "iptables", "-D", chain, str(num)])

for host_port, vm_port in ports:
    delete_nat("PREROUTING", host_port)
    delete_nat("OUTPUT", host_port)
    delete_forward("FORWARD", vm_port)
    delete_forward("LIBVIRT_FWI", vm_port)
PY

echo "Cleanup complete."
EOF

      - name: Install fresh agent VM
        env:
          SSH_KEY: ${{ steps.ssh-key.outputs.file }}
          CONTROL_VM_NAME: ${{ github.event.inputs.control_vm_name || 'ee-control' }}
          CONTROL_VM_PORT: ${{ github.event.inputs.control_vm_port || '8000' }}
          CONTROL_HOST_PORT: ${{ github.event.inputs.control_host_port || '8000' }}
          CONTACT_VM_NAME: ${{ github.event.inputs.contact_vm_name || 'ee-contacts' }}
          CONTACT_VM_PORT: ${{ github.event.inputs.contact_vm_port || '8001' }}
          CONTACT_HOST_PORT: ${{ github.event.inputs.contact_host_port || '8001' }}
          VM_IMAGE_TAG: ${{ github.event.inputs.vm_image_tag || format('reset-{0}', github.run_id) }}
        run: |
          set -euo pipefail
          ssh -o StrictHostKeyChecking=no -p "${{ secrets.AGENT_SSH_PORT }}" -i "$SSH_KEY" \
            "${{ secrets.AGENT_SSH_USER }}@${{ secrets.AGENT_SSH_HOST }}" <<EOF
set -euo pipefail
sudo rm -rf /opt/easy-enclave
sudo git clone https://github.com/${{ github.repository }}.git /opt/easy-enclave
cd /opt/easy-enclave
sudo git fetch --tags origin
sudo git checkout "${GITHUB_SHA}"
echo "Installing control agent ${CONTROL_VM_NAME}:${CONTROL_VM_PORT} -> host ${CONTROL_HOST_PORT}"
sudo ./install-agent.sh --non-interactive \
  --vm-name "${CONTROL_VM_NAME}" \
  --vm-port "${CONTROL_VM_PORT}" \
  --host-port "${CONTROL_HOST_PORT}" \
  --vm-image-tag "${VM_IMAGE_TAG}"
echo "Installing contacts agent ${CONTACT_VM_NAME}:${CONTACT_VM_PORT} -> host ${CONTACT_HOST_PORT}"
sudo ./install-agent.sh --non-interactive \
  --vm-name "${CONTACT_VM_NAME}" \
  --vm-port "${CONTACT_VM_PORT}" \
  --host-port "${CONTACT_HOST_PORT}" \
  --vm-image-tag "${VM_IMAGE_TAG}"
EOF

      - name: Verify agent is reachable
        env:
          SSH_KEY: ${{ steps.ssh-key.outputs.file }}
          CONTROL_HOST_PORT: ${{ github.event.inputs.control_host_port || '8000' }}
          CONTACT_HOST_PORT: ${{ github.event.inputs.contact_host_port || '8001' }}
        run: |
          set -euo pipefail
          ssh -o StrictHostKeyChecking=no -p "${{ secrets.AGENT_SSH_PORT }}" -i "$SSH_KEY" \
            "${{ secrets.AGENT_SSH_USER }}@${{ secrets.AGENT_SSH_HOST }}" \
            "for port in ${CONTROL_HOST_PORT} ${CONTACT_HOST_PORT}; do
               curl -fsS --max-time 10 http://127.0.0.1:${port}/health || (sudo ss -lntp && exit 1)
             done"
