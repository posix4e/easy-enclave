name: Pipeline Dev

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  actions: read

concurrency:
  group: pipeline-dev
  cancel-in-progress: true

jobs:
  reset-agents:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    needs: lint-test
    steps:
      - uses: actions/checkout@v4

      - name: Uninstall contacts agent
        uses: ./action/uninstall-agent
        with:
          ssh-host: ${{ secrets.CONTACT_SSH_HOST || secrets.AGENT_SSH_HOST }}
          ssh-port: ${{ secrets.CONTACT_SSH_PORT || secrets.AGENT_SSH_PORT || '22' }}
          ssh-user: ${{ secrets.CONTACT_SSH_USER || secrets.AGENT_SSH_USER || 'ubuntu' }}
          ssh-key: ${{ secrets.CONTACT_SSH_KEY || secrets.AGENT_SSH_KEY }}
          vm-name: ee-contacts
          vm-port: 8000
          host-port: 443
          public-ip: 57.130.34.193

      - name: Uninstall control-plane agent
        uses: ./action/uninstall-agent
        with:
          ssh-host: ${{ secrets.AGENT_SSH_HOST }}
          ssh-port: ${{ secrets.AGENT_SSH_PORT || '22' }}
          ssh-user: ${{ secrets.AGENT_SSH_USER || 'ubuntu' }}
          ssh-key: ${{ secrets.AGENT_SSH_KEY }}
          vm-name: ee-control
          vm-port: 8000
          host-port: 443
          public-ip: 57.130.10.246

      - name: Install control-plane agent
        uses: ./action/install-control-agent
        with:
          ssh-host: ${{ secrets.AGENT_SSH_HOST }}
          ssh-port: ${{ secrets.AGENT_SSH_PORT || '22' }}
          ssh-user: ${{ secrets.AGENT_SSH_USER || 'ubuntu' }}
          ssh-key: ${{ secrets.AGENT_SSH_KEY }}
          vm-name: ee-control
          vm-port: 8000
          host-port: 443
          public-ip: 57.130.10.246
          vm-image-tag: dev-latest
          dns-name: control.easyenclave.com
          cloudflare-api-token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          cloudflare-zone: ${{ secrets.CLOUDFLARE_ZONE || 'easyenclave.com' }}
          cloudflare-zone-id: ${{ secrets.CLOUDFLARE_ZONE_ID }}

      - name: Install contacts agent
        uses: ./action/install-contacts-agent
        with:
          ssh-host: ${{ secrets.CONTACT_SSH_HOST || secrets.AGENT_SSH_HOST }}
          ssh-port: ${{ secrets.CONTACT_SSH_PORT || secrets.AGENT_SSH_PORT || '22' }}
          ssh-user: ${{ secrets.CONTACT_SSH_USER || secrets.AGENT_SSH_USER || 'ubuntu' }}
          ssh-key: ${{ secrets.CONTACT_SSH_KEY || secrets.AGENT_SSH_KEY }}
          vm-name: ee-contacts
          vm-port: 8000
          host-port: 443
          public-ip: 57.130.34.193
          vm-image-tag: dev-latest
          dns-name: contacts.easyenclave.com
          cloudflare-api-token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          cloudflare-zone: ${{ secrets.CLOUDFLARE_ZONE || 'easyenclave.com' }}
          cloudflare-zone-id: ${{ secrets.CLOUDFLARE_ZONE_ID }}

  lint-test:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install ruff pytest pytest-cov "requests>=2.28.0" "cryptography>=41.0.0" "urllib3<2"
      - name: Lint
        run: ruff check .
      - name: SDK tests
        run: PYTHONPATH=$PWD/sdk pytest sdk/tests -v

  deploy-dev:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [lint-test, reset-agents]
    env:
      CONTROL_URL: ${{ secrets.AGENT_URL_CONTROL || secrets.AGENT_URL || 'https://control.easyenclave.com' }}
      CONTACTS_URL: ${{ secrets.AGENT_URL_CONTACTS || 'https://contacts.easyenclave.com' }}
      ADMIN_TOKEN: ${{ secrets.AGENT_ADMIN_TOKEN }}
    steps:
      - uses: actions/checkout@v4

      - name: Ensure agent URLs are configured
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${CONTROL_URL:-}" ]; then
            echo "CONTROL_URL is required (set AGENT_URL_CONTROL or AGENT_URL secret)"
            exit 1
          fi
          if [ -z "${CONTACTS_URL:-}" ]; then
            echo "CONTACTS_URL is required (set AGENT_URL_CONTACTS or AGENT_URL secret)"
            exit 1
          fi
          if [ -z "${ADMIN_TOKEN:-}" ]; then
            echo "ADMIN_TOKEN missing; admin endpoints will be unauthenticated"
          fi

      - name: Normalize agent URLs (prefer 443/HTTPS)
        shell: bash
        run: |
          set -euo pipefail
          DEFAULT_CONTROL="https://control.easyenclave.com"
          DEFAULT_CONTACTS="https://contacts.easyenclave.com"
          normalize() {
            local url="$1"
            local fallback="$2"
            if [ -z "$url" ]; then
              url="$fallback"
            fi
            if [[ "$url" =~ ^https?://[^/]+:8000(/.*)?$ ]]; then
              local rest="${url#*:8000}"
              url="${url%:8000*}:443${rest}"
            fi
            if [[ "$url" == http://*:443* ]]; then
              url="https://${url#http://}"
            fi
            echo "$url"
          }
          admin_url() {
            local url="$1"
            local host="${url#*://}"
            host="${host%%/*}"
            host="${host%%:*}"
            local base="${host%%.*}"
            local rest="${host#*.}"
            if [ "$rest" = "$host" ]; then
              echo "https://admin-${host}"
              return
            fi
            echo "https://admin-${base}.${rest}"
          }
          CONTROL_URL=$(normalize "${CONTROL_URL:-}" "$DEFAULT_CONTROL")
          CONTACTS_URL=$(normalize "${CONTACTS_URL:-}" "$DEFAULT_CONTACTS")

          control_host=${CONTROL_URL#*://}; control_host=${control_host%%/*}; control_base=${control_host%%:*}
          contacts_host=${CONTACTS_URL#*://}; contacts_host=${contacts_host%%/*}; contacts_base=${contacts_host%%:*}
          if [ "$control_base" = "$contacts_base" ]; then
            echo "CONTACTS_URL matches control host; using $DEFAULT_CONTACTS instead"
            CONTACTS_URL="$DEFAULT_CONTACTS"
          fi
          echo "CONTROL_URL=$CONTROL_URL" >> "$GITHUB_ENV"
          echo "CONTACTS_URL=$CONTACTS_URL" >> "$GITHUB_ENV"
          echo "CONTROL_ADMIN_URL=$(admin_url "$CONTROL_URL")" >> "$GITHUB_ENV"
          echo "CONTACTS_ADMIN_URL=$(admin_url "$CONTACTS_URL")" >> "$GITHUB_ENV"

      - name: Wait for control agent health
        shell: bash
        run: |
          set -euo pipefail
          URL="${CONTROL_URL}"
          CURL_OPTS=(--silent --show-error --connect-timeout 5 --max-time 15)
          if [[ "$URL" == https://* ]]; then
            CURL_OPTS+=(--insecure)
          fi
          for i in {1..8}; do
            if curl "${CURL_OPTS[@]}" "$URL/health" >/dev/null 2>&1; then
              echo "control agent healthy"
              exit 0
            fi
            echo "waiting for control agent health ($i/8)..."
            sleep 10
          done
          echo "::error::Control agent did not respond to /health"
          exit 1

      - name: Reset control-plane agent
        shell: bash
        run: |
          set -euo pipefail
          AUTH=()
          if [ -n "${ADMIN_TOKEN:-}" ]; then
            AUTH+=( -H "Authorization: Bearer ${ADMIN_TOKEN}" )
          fi
          CURL_OPTS=(--max-time 30 -sS -X POST)
          if [[ "${CONTROL_ADMIN_URL:-}" == https://* ]]; then
            CURL_OPTS+=(--insecure)
          fi
          curl "${CURL_OPTS[@]}" "${AUTH[@]}" "${CONTROL_ADMIN_URL}/admin/undeploy" || { echo "control-plane reset timed out/failed, continuing"; }

      - name: Reset contacts agent
        shell: bash
        run: |
          set -euo pipefail
          AUTH=()
          if [ -n "${ADMIN_TOKEN:-}" ]; then
            AUTH+=( -H "Authorization: Bearer ${ADMIN_TOKEN}" )
          fi
          CURL_OPTS=(--max-time 30 -sS -X POST)
          if [[ "${CONTACTS_ADMIN_URL:-}" == https://* ]]; then
            CURL_OPTS+=(--insecure)
          fi
          curl "${CURL_OPTS[@]}" "${AUTH[@]}" "${CONTACTS_ADMIN_URL}/admin/undeploy" || { echo "contacts reset timed out/failed, continuing"; }

      - name: Deploy contacts app
        uses: ./action
        with:
          agent-url: ${{ env.CONTACTS_URL }}
          agent-ratls: 'true'
          agent-release-tag: dev-latest
          bundle-inline: 'true'
          docker-compose: ./example/contact-compose.yml
          public-env: |
            PUBLIC_GREETING=Hello from Easy Enclave
            PUBLIC_REGION=us-east-demo
            CONTACT_API_TOKEN=public-demo-token
          private-env: |
            CONTACT_API_TOKEN=${{ secrets.DEMO_CONTACT_TOKEN }}
          unseal-password: ${{ secrets.DEMO_UNSEAL_PASSWORD }}
          github-developer: posix4e
          seal-vm: 'false'
          github-token: ${{ secrets.GITHUB_TOKEN }}
