name: Pipeline Dev

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  actions: read

concurrency:
  group: pipeline-dev
  cancel-in-progress: true

jobs:
  lint-test:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install ruff pytest pytest-cov "requests>=2.28.0" "cryptography>=41.0.0" "urllib3<2"
      - name: Lint
        run: ruff check .
      - name: SDK tests
        run: PYTHONPATH=$PWD/sdk pytest sdk/tests -v

  deploy-dev:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: lint-test
    env:
      CONTROL_URL: ${{ secrets.AGENT_URL_CONTROL || secrets.AGENT_URL }}
      CONTACTS_URL: ${{ secrets.AGENT_URL_CONTACTS || secrets.AGENT_URL }}
      ADMIN_TOKEN: ${{ secrets.AGENT_ADMIN_TOKEN }}
    steps:
      - uses: actions/checkout@v4

      - name: Ensure agent URLs are configured
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${CONTROL_URL:-}" ]; then
            echo "CONTROL_URL is required (set AGENT_URL_CONTROL or AGENT_URL secret)"
            exit 1
          fi
          if [ -z "${CONTACTS_URL:-}" ]; then
            echo "CONTACTS_URL is required (set AGENT_URL_CONTACTS or AGENT_URL secret)"
            exit 1
          fi
          if [ -z "${ADMIN_TOKEN:-}" ]; then
            echo "ADMIN_TOKEN missing; admin endpoints will be unauthenticated"
          fi

      - name: Undeploy control-plane agent
        shell: bash
        run: |
          set -euo pipefail
          AUTH=()
          if [ -n "${ADMIN_TOKEN:-}" ]; then
            AUTH+=( -H "Authorization: Bearer ${ADMIN_TOKEN}" )
          fi
          curl --max-time 30 -sS -X POST "${AUTH[@]}" "${CONTROL_URL}/admin/undeploy" || true

      - name: Undeploy contacts agent
        shell: bash
        run: |
          set -euo pipefail
          AUTH=()
          if [ -n "${ADMIN_TOKEN:-}" ]; then
            AUTH+=( -H "Authorization: Bearer ${ADMIN_TOKEN}" )
          fi
          curl --max-time 30 -sS -X POST "${AUTH[@]}" "${CONTACTS_URL}/admin/undeploy" || true

      - name: Deploy control plane
        uses: ./action
        with:
          agent-url: ${{ env.CONTROL_URL }}
          agent-ratls: 'true'
          bundle-inline: 'true'
          docker-compose: control_plane/docker-compose.yml
          public-files: control_plane,sdk
          private-env: |
            EE_GITHUB_TOKEN=${{ secrets.CONTROL_GITHUB_TOKEN || github.token }}
            EE_ADMIN_TOKEN=${{ secrets.CONTROL_ADMIN_TOKEN }}
            EE_RATLS_REQUIRE_CLIENT_CERT=false
            EE_DNS_UPDATE_ON_START=true
            EE_DNS_AUTO_IP=true
            EE_DNS_FAIL_ON_ERROR=false
            EE_DNS_PROXIED=false
            CLOUDFLARE_API_TOKEN=${{ secrets.CLOUDFLARE_API_TOKEN }}
            CLOUDFLARE_ZONE=${{ secrets.CLOUDFLARE_ZONE }}
            CLOUDFLARE_ZONE_ID=${{ secrets.CLOUDFLARE_ZONE_ID }}
          endpoint-port: 9090
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy contacts app
        uses: ./action
        with:
          agent-url: ${{ env.CONTACTS_URL }}
          agent-ratls: 'true'
          bundle-inline: 'true'
          docker-compose: ./example/contact-compose.yml
          public-env: |
            PUBLIC_GREETING=Hello from Easy Enclave
            PUBLIC_REGION=us-east-demo
            CONTACT_API_TOKEN=public-demo-token
          private-env: |
            CONTACT_API_TOKEN=${{ secrets.DEMO_CONTACT_TOKEN }}
          unseal-password: ${{ secrets.DEMO_UNSEAL_PASSWORD }}
          github-developer: posix4e
          seal-vm: 'false'
          github-token: ${{ secrets.GITHUB_TOKEN }}
