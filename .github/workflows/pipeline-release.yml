name: Pipeline Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write
  actions: read

concurrency:
  group: pipeline-release
  cancel-in-progress: true

jobs:
  lint-test:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install ruff pytest pytest-cov "requests>=2.28.0" "cryptography>=41.0.0" "urllib3<2"
      - name: Lint
        run: ruff check .
      - name: SDK tests
        run: PYTHONPATH=$PWD/sdk pytest sdk/tests -v

  deploy-release:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: lint-test
    env:
      CONTROL_URL: ${{ secrets.AGENT_URL_CONTROL || secrets.AGENT_URL }}
      CONTACTS_URL: ${{ secrets.AGENT_URL_CONTACTS || secrets.AGENT_URL }}
      ADMIN_TOKEN: ${{ secrets.AGENT_ADMIN_TOKEN }}
      RELEASE_TAG: ${{ github.ref_name }}
    steps:
      - uses: actions/checkout@v4

      - name: Ensure agent URLs are configured
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${CONTROL_URL:-}" ]; then
            echo "CONTROL_URL is required (set AGENT_URL_CONTROL or AGENT_URL secret)"
            exit 1
          fi
          if [ -z "${CONTACTS_URL:-}" ]; then
            echo "CONTACTS_URL is required (set AGENT_URL_CONTACTS or AGENT_URL secret)"
            exit 1
          fi
          if [ -z "${ADMIN_TOKEN:-}" ]; then
            echo "ADMIN_TOKEN missing; admin endpoints will be unauthenticated"
          fi
          DEFAULT_CONTROL="https://control.easyenclave.com"
          DEFAULT_CONTACTS="https://contacts.easyenclave.com"
          normalize() {
            local url="$1"
            local fallback="$2"
            if [ -z "$url" ]; then
              url="$fallback"
            fi
            if [[ "$url" =~ ^https?://[^/]+:8000(/.*)?$ ]]; then
              local rest="${url#*:8000}"
              url="${url%:8000*}:443${rest}"
            fi
            if [[ "$url" == http://*:443* ]]; then
              url="https://${url#http://}"
            fi
            echo "$url"
          }
          admin_url() {
            local url="$1"
            local host="${url#*://}"
            host="${host%%/*}"
            host="${host%%:*}"
            local base="${host%%.*}"
            local rest="${host#*.}"
            if [ "$rest" = "$host" ]; then
              echo "https://admin-${host}"
              return
            fi
            echo "https://admin-${base}.${rest}"
          }
          is_private_host() {
            local host="$1"
            if [ "$host" = "localhost" ]; then
              return 0
            fi
            if [[ ! "$host" =~ ^[0-9]+(\.[0-9]+){3}$ ]]; then
              return 1
            fi
            if [[ "$host" == 10.* || "$host" == 192.168.* || "$host" == 127.* || "$host" == 169.254.* ]]; then
              return 0
            fi
            if [[ "$host" =~ ^172\.(1[6-9]|2[0-9]|3[0-1])\. ]]; then
              return 0
            fi
            return 1
          }
          CONTROL_URL=$(normalize "${CONTROL_URL:-}" "$DEFAULT_CONTROL")
          CONTACTS_URL=$(normalize "${CONTACTS_URL:-}" "$DEFAULT_CONTACTS")
          control_host=${CONTROL_URL#*://}; control_host=${control_host%%/*}; control_base=${control_host%%:*}
          contacts_host=${CONTACTS_URL#*://}; contacts_host=${contacts_host%%/*}; contacts_base=${contacts_host%%:*}
          if is_private_host "$control_base"; then
            echo "::error::CONTROL_URL must use a public host (got ${control_base})"
            exit 1
          fi
          if is_private_host "$contacts_base"; then
            echo "::error::CONTACTS_URL must use a public host (got ${contacts_base})"
            exit 1
          fi
          echo "CONTROL_URL=$CONTROL_URL" >> "$GITHUB_ENV"
          echo "CONTACTS_URL=$CONTACTS_URL" >> "$GITHUB_ENV"
          echo "CONTROL_ADMIN_URL=$(admin_url "$CONTROL_URL")" >> "$GITHUB_ENV"
          echo "CONTACTS_ADMIN_URL=$(admin_url "$CONTACTS_URL")" >> "$GITHUB_ENV"

      - name: Undeploy control-plane agent
        shell: bash
        run: |
          set -euo pipefail
          AUTH=()
          if [ -n "${ADMIN_TOKEN:-}" ]; then
            AUTH+=( -H "Authorization: Bearer ${ADMIN_TOKEN}" )
          fi
          CURL_OPTS=(-sS -X POST)
          if [[ "${CONTROL_ADMIN_URL:-}" == https://* ]]; then
            CURL_OPTS+=(--insecure)
          fi
          curl "${CURL_OPTS[@]}" "${AUTH[@]}" "${CONTROL_ADMIN_URL}/admin/undeploy" || true

      - name: Undeploy contacts agent
        shell: bash
        run: |
          set -euo pipefail
          AUTH=()
          if [ -n "${ADMIN_TOKEN:-}" ]; then
            AUTH+=( -H "Authorization: Bearer ${ADMIN_TOKEN}" )
          fi
          CURL_OPTS=(-sS -X POST)
          if [[ "${CONTACTS_ADMIN_URL:-}" == https://* ]]; then
            CURL_OPTS+=(--insecure)
          fi
          curl "${CURL_OPTS[@]}" "${AUTH[@]}" "${CONTACTS_ADMIN_URL}/admin/undeploy" || true

      - name: Deploy contacts app (sealed)
        uses: ./action
        with:
          agent-url: ${{ env.CONTACTS_URL }}
          agent-ratls: 'true'
          bundle-inline: 'true'
          agent-release-tag: ${{ env.RELEASE_TAG }}
          docker-compose: ./example/contact-compose.yml
          public-env: |
            PUBLIC_GREETING=Hello from Easy Enclave
            PUBLIC_REGION=us-east-demo
            CONTACT_API_TOKEN=public-demo-token
          private-env: |
            CONTACT_API_TOKEN=${{ secrets.DEMO_CONTACT_TOKEN }}
          unseal-password: ${{ secrets.DEMO_UNSEAL_PASSWORD }}
          github-developer: posix4e
          seal-vm: 'true'
          github-token: ${{ secrets.GITHUB_TOKEN }}
