services:
  control-plane-prod:
    image: python:3.12-slim
    working_dir: /opt/app
    command: >
      bash -c "pip install --no-cache-dir -r /opt/app/control_plane/requirements.txt
      && python /opt/app/control_plane/server.py"
    env_file:
      - .env
    environment:
      EE_CONTROL_BIND: 0.0.0.0
      EE_CONTROL_PORT: 8088
      EE_PROXY_BIND: 0.0.0.0
      EE_PROXY_PORT: 9090
      EE_DB_PATH: /var/lib/easy-enclave/control-plane.db
      EE_ALLOWLIST_ASSET: agent-attestation-allowlist.json
      EE_GITHUB_TOKEN: ${EE_GITHUB_TOKEN}
      EE_ADMIN_TOKEN: ${EE_ADMIN_TOKEN}
    volumes:
      - .:/opt/app/control_plane:ro
      - control-plane-data:/var/lib/easy-enclave
    ports:
      - "8088:8088"
      - "9090:9090"

  caddy:
    build:
      context: .
      dockerfile: Caddy.Dockerfile
    restart: unless-stopped
    env_file:
      - .env
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config

volumes:
  caddy-data:
  caddy-config:
  control-plane-data:
