services:
  control-plane-prod:
    image: python:3.12-slim
    working_dir: /opt/app/control_plane
    privileged: true
    command: >
      bash -c "python -m venv /var/lib/easy-enclave/venv && if [ -d /opt/app/control_plane/wheels ] && ls /opt/app/control_plane/wheels/*.whl >/dev/null 2>&1; then /var/lib/easy-enclave/venv/bin/pip install --no-index --find-links /opt/app/control_plane/wheels -r /opt/app/control_plane/requirements.runtime.txt; else /var/lib/easy-enclave/venv/bin/pip install --no-cache-dir -r /opt/app/control_plane/requirements.txt; fi && PYTHONPATH=/opt/app:/opt/app/sdk /var/lib/easy-enclave/venv/bin/python /opt/app/control_plane/server.py"
    env_file:
      - .env
    environment:
      EE_CONTROL_BIND: 0.0.0.0
      EE_CONTROL_PORT: 8088
      EE_PROXY_BIND: 0.0.0.0
      EE_PROXY_PORT: 9090
      EE_DB_PATH: /var/lib/easy-enclave/control-plane.db
      EE_ALLOWLIST_ASSET: agent-attestation-allowlist.json
      EE_GITHUB_TOKEN: ${EE_GITHUB_TOKEN}
      EE_ADMIN_TOKEN: ${EE_ADMIN_TOKEN}
    volumes:
      - ..:/opt/app:ro
      - control-plane-data:/var/lib/easy-enclave
      - /sys/kernel/config:/sys/kernel/config
    ports:
      - "8088:8088"
      - "9090:9090"

volumes:
  control-plane-data:
