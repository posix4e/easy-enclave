# Example Nginx config for app.easyenclave.com routing.
# Requires a separate tunnel proxy that can reach agent backends by app_name.

map $host $app_name {
    default "";
    ~^(?<name>[^.]+)\.app\.easyenclave\.com$ $name;
}

upstream ee_control_plane {
    server 127.0.0.1:8088;
}

upstream ee_tunnel_proxy {
    server 127.0.0.1:9090;
}

server {
    listen 443 ssl;
    server_name *.app.easyenclave.com;

    ssl_certificate     /etc/letsencrypt/live/app.easyenclave.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/app.easyenclave.com/privkey.pem;

    if ($app_name = "") {
        return 404;
    }

    # Ensure attestation/health/TTL are valid before routing.
    auth_request /_ee_auth;

    location /_ee_auth {
        internal;
        proxy_pass http://ee_control_plane/v1/resolve/$app_name;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header X-Original-URI $request_uri;
        proxy_set_header Host $host;

        # Map JSON response to auth status.
        proxy_intercept_errors on;
        error_page 200 = @ee_auth_ok;
        error_page 404 403 503 = @ee_auth_fail;
    }

    location @ee_auth_ok {
        proxy_pass http://ee_tunnel_proxy;
        proxy_set_header Host $host;
        proxy_set_header X-EE-App $app_name;
    }

    location @ee_auth_fail {
        return 403;
    }

    location / {
        proxy_pass http://ee_tunnel_proxy;
        proxy_set_header Host $host;
        proxy_set_header X-EE-App $app_name;
    }
}
