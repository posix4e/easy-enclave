name: 'Easy Enclave Attest'
description: 'Deploy workload in TDX VM and create attested GitHub release'
inputs:
  docker-compose:
    description: 'Path to docker-compose.yml'
    required: true
    default: './docker-compose.yml'
  endpoint:
    description: 'Public endpoint URL for the service (use "auto" for http://{vm_ip}:8080)'
    required: false
    default: 'auto'
  endpoint-port:
    description: 'Port for auto-generated endpoint (used when endpoint is "auto")'
    required: false
    default: '8080'
  github-token:
    description: 'GitHub token for creating releases'
    required: true
    default: ${{ github.token }}
  vm-name:
    description: 'Name for the TD VM'
    required: false
    default: 'ee-workload'
outputs:
  vm_ip:
    description: 'IP address of the created TD VM'
    value: ${{ steps.vm.outputs.vm_ip }}
  quote:
    description: 'Base64-encoded TDX quote'
    value: ${{ steps.vm.outputs.quote }}
runs:
  using: 'composite'
  steps:
    - name: Setup TDX environment
      shell: bash
      run: |
        # Force destroy old VM if exists
        sudo virsh destroy ${{ inputs.vm-name }} 2>/dev/null || true
        sudo virsh undefine ${{ inputs.vm-name }} --nvram 2>/dev/null || true
        # Ensure libvirt default network is active
        if ! sudo virsh net-info default 2>/dev/null | grep -q "Active:.*yes"; then
          echo "Starting libvirt default network..."
          sudo virsh net-start default 2>/dev/null || true
        fi
        # Fix vsock permissions for QEMU to connect to QGS
        sudo chmod 666 /dev/vhost-vsock /dev/vsock 2>/dev/null || true

    - name: Create TD VM with Workload
      id: vm
      shell: bash
      run: |
        python3 ${{ github.action_path }}/src/vm.py ${{ inputs.docker-compose }} --name ${{ inputs.vm-name }} > /tmp/vm_result.json
        echo "quote=$(jq -r .quote /tmp/vm_result.json)" >> $GITHUB_OUTPUT
        echo "vm_ip=$(jq -r .ip /tmp/vm_result.json)" >> $GITHUB_OUTPUT

    - name: Create Attested Release
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.github-token }}
        ENDPOINT: ${{ inputs.endpoint == 'auto' && format('http://{0}:{1}', steps.vm.outputs.vm_ip, inputs.endpoint-port) || inputs.endpoint }}
        QUOTE: ${{ steps.vm.outputs.quote }}
      run: python3 ${{ github.action_path }}/src/release.py
